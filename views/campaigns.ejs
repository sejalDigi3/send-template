<%- include('partials/head.ejs') %>

<body>

  <style>
    .parentContainerOfAllchild {
      min-height: 100%;
      background: white;
    }

    .buttonsSection {
      justify-content: space-between;
      display: flex;
      flex-direction: row-reverse;
    }

    .buttonsSection a:hover {
      color: white;
    }

    .buttonsSection a {
      text-decoration: none;
    }

    .buttonsSection a {
      background-color: #ffffff;
    }

    .table td {
      max-width: 200px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: normal;
      word-wrap: break-word;
    }
    .parentContainerOfAllchild {
        min-height: 100%;
        background: white;
      }

      .buttonsSection {
        /* padding: 15px; */
        justify-content: space-between;
        display: flex;
        flex-direction: row-reverse;
      }

      .buttonsSection a:hover {
        color: white;
      }

      .buttonsSection a {
        text-decoration: none;
      }

      .buttonsSection a {
        background-color: #ffffff;
      }

      .table td {
                       max-width: 200px;
                       white-space: nowrap;
                       overflow: hidden;
                       text-overflow: ellipsis;
                       white-space: normal;
                       word-wrap: break-word;
                   }
        .search-container {
            margin-bottom: 20px;
        }

        .search-container input[type="text"] {
            width: 100%;
            padding: 12px 20px;
            margin: 8px 0;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
#UniqueDesignForModal{
  width: 50%;
  margin: auto;
  margin-top: 17%;
  background: white;
}

  .modal {
                    display: none;
                    position: fixed;
                    z-index: 1;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.4);
                  }

                  .modal-content {
                    background-color: #fff;
                    margin: 22% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 45%;
                    box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
                    padding: 44px;
                    padding-top: 25px;
                  }

                  .close {
                    color: #aaa;
                    float: right;
                    font-size: 28px;
                    font-weight: bold;
                    cursor: pointer;
                    display: flex;
                    flex-direction: row-reverse;
                  }

                  .close:hover {
                    color: black;
                  }

                    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }

    .pagination button {
      margin: 0 5px;
      padding: 5px 10px;
      border-radius: 5px;
      background-color: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
    }

    .pagination button:hover {
      background-color: #0056b3;
    }

  /* modal design */
  </style>

  <div class="container-scroller">
    <%- include('partials/navbar.ejs') %>
    <div class="container-fluid page-body-wrapper">
      <%- include('partials/sidebar.ejs') %>
      <div class="main-panel">
        <div class="content-wrapper">
          <div class="page-header">
            <h3 class="page-title">
              <span class="page-title-icon bg-gradient-primary text-white me-2">
                <i class="mdi mdi-home"></i>
              </span> campaigns
            </h3>
          </div>

          <div class="buttonsSection">
            <a href="/createCampaigns" class="button-12" id="openModalBtn" style="display: flex; align-items: center;">
              <span style="margin-left: -18px; color: black;">Create</span>
              <i class="fa-solid fa-plus" style="margin-left: 56px; margin-top: -17px; color:black;"></i>
            </a>
          </div>

          <div class="row" style="margin-top: 6px;">
            <div class="col-lg-12 grid-margin stretch-card">
              <div class="card">
                <div class="card-body">
                  <!-- <a href="/detaildcampaignHistory">Click here</a> -->
                  <h1></h1>

                  <input type="search" style="float: right;" onkeyup="searchHere()" id="searchInput" name="q"
                    placeholder="Search...." aria-label="Search">
                  <div class="containPaginationINfo"></div>
                                    <!-- <input type="text" id="searchInput" placeholder="Search for campaign..."> -->
                  <table class="table">
                    <thead>
                      <tr>
                        <th>Campaign Name</th>
                        <th>Contacts</th>
                        <th>Template</th>
                        <th>Created At</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% for (let i=0; i < campaigns.length; i++) { %>
                      <tr>
                        <td><%= campaigns[i].campaignName %></td>
                        <td><%= campaigns[i].phoneOfTemp %></td>
                        <td><%= campaigns[i].messageType %></td>
                        <td><%= new Date(campaigns[i].createdAt).toLocaleString('en-US', { timeZone: 'Asia/Kolkata' }) %></td>
                        <td style="width: 92px;">
                          <a href="#"
                            onclick="redirectToSendCampaign('<%= campaigns[i].phoneOfTemp %>', '<%= campaigns[i].messageType %>')"
                            style="text-decoration: none; color: white; background-color: #015401; padding: 5px; border-radius: 3px; display: flex; justify-content: space-between;">
                            <i class="fa fa-paper-plane" aria-hidden="true" style="color: white"></i><span>Sent</span>
                          </a>
                        </td>
                        <td style="width: 92px;">
  <a href="#" onclick="deleteCampaign('<%= campaigns[i]._id %>')" style="text-decoration: none; color: rgb(15, 0, 0); background-color: #ffffff; padding: 5px; border-radius: 3px;">
    <i class="fa fa-trash" aria-hidden="true"></i>
  </a>
</td>

                      </tr>
                      <% } %>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>


                <div class="row" style="margin-top: 6px;">
                  <div class="col-lg-12 grid-margin stretch-card">
                    <div class="card">
                      <h2 class="text-center mt-5">Campaign Details</h2>
                      <div class="card-body">



                                <!-- Search container -->
                                <div class="search-container">
                                    <input type="text" id="searchInput" placeholder="Search for campaign...">
                                </div>

                        <div class="containPaginationINfo">
                          <!-- <h3>Message Has Been Sent</h3> -->
                        </div>

                        <div class="table-container">
                                 <p>Click on the file and Group name to see the phone numbers and name</p>
                            <table class="table">
                                <!-- style="background-color: lightgray;" -->
                                <thead>
                                    <tr>
                                        <th>Index</th>
                                        <th>Campaign Name</th>
                                        <th>Message Type</th>
                                        <th>Template Name</th>
                                        <th>Contacts </th>
                                        <th>Created At</th>
                                        <!-- <th>Action</th> Add a new column for the button -->
                                    </tr>
                                </thead>
                                <!-- Inside your EJS template (DetailCampaignHistory.ejs) -->
                                <tbody>
                                    <% showingcampaignHistory.forEach((campaign, index) => { %>
                                        <tr>
                                            <td><%= index + 1 %></td>
                                            <td><%= campaign.campaignName %></td>
                                            <td><%= campaign.messageType %></td>
                                            <td><%= campaign.message %></td>
                                            <td>
                                                <% if (campaign.phoneNumbers) { %>
                                                    <%= campaign.phoneNumbers %>
                                                <% } else if (campaign.GroupName) { %>
                                                    <a href="#" onclick="openModal('<%= campaign.GroupName %>')">
                                                        <%= campaign.GroupName %>
                                                    </a>
                                                <% } else if (campaign.fileName) { %>
                                                    <a href="#" onclick="openModal('<%= campaign.fileName %>')">
                                                        <%= campaign.fileName %>
                                                    </a>
                                                <% } %>
                                            </td>
                                            <td>
                                                <%= new Date(campaign.createdAt).toLocaleString('en-US', { timeZone: 'Asia/Kolkata' }) %>
                                            </td>
                                            <td><!-- Add actions/button here --></td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                          </div>

                      </div>
                     </div>
                  </div>
                  </div>

                    </body>
  <script>
  function redirectToSendCampaign(phoneOfTemp, messageType) {
      if (messageType === 'custom') {
        window.location.href = `/sendCampaignMessage?phoneOfTemp=${phoneOfTemp}&messageType=custom`;
      } else if (messageType === 'template') {
        window.location.href = `/sendCampaignMessage?phoneOfTemp=${phoneOfTemp}&messageType=template`;
      }
    }

  function deleteCampaign(campaignId) {
  if (confirm("Are you sure you want to delete this campaign?")) {
    fetch(`/deleteCampaign/${campaignId}`, {
      method: 'DELETE'
    })
    .then(response => {
      if (response.ok) {
        // Update the UI to remove the deleted campaign
        document.getElementById(campaignId).remove();
      } else {
        throw new Error('Failed to delete campaign');
      }
    })
    .catch(error => {
      console.error('Error deleting campaign:', error);
    });
  }
}

   function searchHere() {
      var input, filter, table, tr, td, i;
      input = document.getElementById("searchInput");
      filter = input.value.toUpperCase();
      table = document.querySelector(".table");
      tr = table.getElementsByTagName("tr");
      for (i = 0; i < tr.length; i++) {
        var found = false;
        for (var j = 0; j < tr[i].cells.length; j++) {
          td = tr[i].cells[j];
          if (td) {
            if (td.innerHTML.toUpperCase().indexOf(filter) > -1) {
              found = true;
            }
          }
        }
        if (found) {
          tr[i].style.display = "";
        } else {
          tr[i].style.display = "none";
        }
      }
    }

   function filterTable() {
        var input, filter, table, tr, td, i, txtValue;
        input = document.getElementById("searchInput");
        filter = input.value.toUpperCase();
        table = document.querySelector(".table");
        tr = table.getElementsByTagName("tr");
        for (i = 0; i < tr.length; i++) {
            td = tr[i].getElementsByTagName("td")[1]; // Change index to the column you want to search
            if (td) {
                txtValue = td.textContent || td.innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }

    document.getElementById("searchInput").addEventListener("keyup", filterTable);

    function openModal(name) {
        var modal = document.getElementById('myModal');
        modal.style.display = 'block';
        // Use the 'name' parameter here as needed
    }

    function closeModal() {
        var modal = document.getElementById('myModal');
        modal.style.display = 'none';
    }

    window.onclick = function (event) {
        var modal = document.getElementById('myModal');
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    };

    function filterTable() {
        var input, filter, table, tr, td, i, txtValue;
        input = document.getElementById("searchInput");
        filter = input.value.toUpperCase();
        table = document.querySelector(".table");
        tr = table.getElementsByTagName("tr");
        for (i = 0; i <script tr.length; i++) {
            td = tr[i].getElementsByTagName("td")[1]; // Change index to the column you want to search
            if (td) {
                txtValue = td.textContent || td.innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }

    document.getElementById("searchInput").addEventListener("keyup", filterTable);

     // Function to filter table rows based on search input
  function searchTable(inputId, tableClass, columnIndex) {
    var input, filter, table, tr, td, i, txtValue;
    input = document.getElementById(inputId);
    filter = input.value.toUpperCase();
    table = document.querySelector(tableClass);
    tr = table.getElementsByTagName("tr");
    for (i = 0; i < tr.length; i++) {
      td = tr[i].getElementsByTagName("td")[columnIndex]; // Get the specific column
      if (td) {
        txtValue = td.textContent || td.innerText;
        if (txtValue.toUpperCase().indexOf(filter) > -1) {
          tr[i].style.display = "";
        } else {
          tr[i].style.display = "none";
        }
      }
    }
  }

  // Attach search function to search input's keyup event
  document.getElementById("searchInputCampaigns").addEventListener("keyup", function() {
    searchTable("searchInputCampaigns", ".table-campaigns", 0); // Search in the first column of campaigns table
  });

  document.getElementById("searchInputCampaignDetails").addEventListener("keyup", function() {
    searchTable("searchInputCampaignDetails", ".table-campaign-details", 1); // Search in the second column of campaign details table
  });

</script>
</html>
